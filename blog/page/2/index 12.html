
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>俺のMoleskin.log</title>
  <meta name="author" content="山本 聡">

  
  <meta name="description" content="　サーブレットをアノテーションで記述できるようになったServlet 3.0ですが、同じようにweb.xmlもJavaConfigで記述できるようです。JAX-RS 2.0などと同じイメージです。 参考までに、それぞれ同じ設定のweb.xmlとJavaConfigを比較しておきます。まずは、web &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://satoshiyamamoto.github.io/blog/page/2">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="俺のMoleskin.log" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">俺のMoleskin.log</a></h1>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:satoshiyamamoto.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/03/18/no-xml-servlet/">Servlet 3.0でNoXMLなContext設定</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-03-18T18:54:59+09:00" pubdate data-updated="true">Mar 18<span>th</span>, 2014</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>　サーブレットをアノテーションで記述できるようになったServlet 3.0ですが、同じようにweb.xmlもJavaConfigで記述できるようです。JAX-RS 2.0などと同じイメージです。</p>

<p>参考までに、それぞれ同じ設定のweb.xmlとJavaConfigを比較しておきます。まずは、web.xmlから。</p>

<div><script src='https://gist.github.com/9617142.js?file=web.xml'></script>
<script type="text/javascript">$(".gist-file table tr td.line-numbers").remove();</script>
<noscript><pre><code>&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;web-app xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; xmlns=&quot;http://java.sun.com/xml/ns/javaee&quot; xsi:schemaLocation=&quot;http://java.sun.com/xml/ns/javaee http://java.sun.com/xml/ns/javaee/web-app_3_0.xsd&quot; version=&quot;3.0&quot;&gt;
    &lt;display-name&gt;spring-mvc-basic&lt;/display-name&gt;
    &lt;description&gt;Spring MVC template project.&lt;/description&gt;
    
    &lt;filter&gt;
        &lt;filter-name&gt;CharacterEncodingFilter&lt;/filter-name&gt;
        &lt;filter-class&gt;org.springframework.web.filter.CharacterEncodingFilter&lt;/filter-class&gt;
        &lt;init-param&gt;
            &lt;param-name&gt;encoding&lt;/param-name&gt;
            &lt;param-value&gt;UTF-8&lt;/param-value&gt;
        &lt;/init-param&gt;
        &lt;init-param&gt;
            &lt;param-name&gt;forceEncoding&lt;/param-name&gt;
            &lt;param-value&gt;true&lt;/param-value&gt;
        &lt;/init-param&gt;
    &lt;/filter&gt;
    &lt;filter&gt;
        &lt;filter-name&gt;HttpMethodFilter&lt;/filter-name&gt;
        &lt;filter-class&gt;org.springframework.web.filter.HiddenHttpMethodFilter&lt;/filter-class&gt;
    &lt;/filter&gt;
    &lt;filter-mapping&gt;
        &lt;filter-name&gt;CharacterEncodingFilter&lt;/filter-name&gt;
        &lt;url-pattern&gt;/*&lt;/url-pattern&gt;
    &lt;/filter-mapping&gt;
    &lt;filter-mapping&gt;
        &lt;filter-name&gt;HttpMethodFilter&lt;/filter-name&gt;
        &lt;url-pattern&gt;/*&lt;/url-pattern&gt;
    &lt;/filter-mapping&gt;
    
    &lt;servlet&gt;
        &lt;servlet-name&gt;spring&lt;/servlet-name&gt;
        &lt;servlet-class&gt;org.springframework.web.servlet.DispatcherServlet&lt;/servlet-class&gt;
        &lt;init-param&gt;
            &lt;param-name&gt;contextConfigLocation&lt;/param-name&gt;
            &lt;param-value&gt;classpath:/applicationContext.xml&lt;/param-value&gt;
        &lt;/init-param&gt;
    &lt;/servlet&gt;
    &lt;servlet-mapping&gt;
        &lt;servlet-name&gt;spring&lt;/servlet-name&gt;
        &lt;url-pattern&gt;/api/*&lt;/url-pattern&gt;
    &lt;/servlet-mapping&gt;
    
&lt;/web-app&gt;</code></pre></noscript></div>


<p>このファイルでは、SpringのDispatcherServletとフィルタの登録を行っています。続いて、JavaConfigです。</p>

<div><script src='https://gist.github.com/9617044.js?file=Application.java'></script>
<script type="text/javascript">$(".gist-file table tr td.line-numbers").remove();</script>
<noscript><pre><code>public class Application implements WebApplicationInitializer {

    @Override
    public void onStartup(ServletContext container) throws ServletException {
        // listener
        XmlWebApplicationContext sc = new XmlWebApplicationContext();
        sc.setConfigLocations(new String[]{&quot;classpath*:META-INF/spring/*-context.xml&quot;});
        container.addListener(new ContextLoaderListener(sc));
        
        // filter
        FilterRegistration.Dynamic cef = container.addFilter(&quot;CharacterEncodingFilter&quot;, CharacterEncodingFilter.class);
        cef.addMappingForUrlPatterns(null, false, &quot;/*&quot;);
        cef.setInitParameter(&quot;encoding&quot;, &quot;UTF-8&quot;);
        cef.setInitParameter(&quot;forceEncoding&quot;, &quot;true&quot;);
        
        FilterRegistration.Dynamic hmf = container.addFilter(&quot;HiddenHttpMethodFilter&quot;, HiddenHttpMethodFilter.class);
        hmf.addMappingForUrlPatterns(null, false, &quot;/*&quot;);

        // servlet
        ServletRegistration.Dynamic api = container.addServlet(&quot;api&quot;, DispatcherServlet.class);
        api.addMapping(&quot;/api/*&quot;);
        
    }

}
</code></pre></noscript></div>


<p>こちらは、前述の設定とApplicationContextの設定を行っています。長年、XMLに慣れてしまったため違和感がありますが、自分はこちらの方が好みです。</p>

<p>長い時間を掛けてシステムを運用していくと、設定ファイルが肥大化していく傾向にあるため、プログラミングベースで設定を記述できれば、単純なスペルミスなど防ぎやすくなると思います。やはり、Converntion over Configurationですね。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/03/15/hbase-0-dot-98-setup-on-os-x/">HadoopとHBaseをOS Xにインストールする</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-03-15T21:18:28+09:00" pubdate data-updated="true">Mar 15<span>th</span>, 2014</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>　Linux上でHDFSの構築ができたので、今回はHomebrewを使ってOS XにHadoopとHBaseを構築します。基本的な作業は前回、前回と同じなので要点を絞って記事に残したいと思います。インストールする環境は次のとおりです。</p>

<h2>環境</h2>

<ul>
<li>Mac OS X 10.9.2 (Marvericks)</li>
<li>JDK 1.8.0 beta 128</li>
<li>Hadoop 2.2.0</li>
<li>HBase 0.98</li>
</ul>


<h2>Homebrewでのインストール方法</h2>

<p>　HomebrewでHadoopとHBaseをインストールします。</p>

<h3>Hadoopのインストール</h3>

<pre><code>$ brew info hadoop
hadoop: stable 2.2.0
    :
$ brew install hadoop
</code></pre>

<h3>HBaseのインストール</h3>

<p>HBaseに関しては、0.98系をインストールできるようにFormulaファイルを修正します。brew editコマンドで、HBaseのダウンロードURLとファイルのハッシュ値を変更します。</p>

<pre><code>$ brew edit hbase
url 'http://ftp.jaist.ac.jp/pub/apache/hbase/hbase-0.98.0/hbase-0.98.0-hadoop2-bin.tar.gz'
sha1 '95cbaf1703a3f4719f67ff0e2d3247155b49fccc'
</code></pre>

<p>brew installでインストールします。</p>

<pre><code>$ brew info hbase
hbase: stable 0.98.0, devel 0.96.1.1
     :

$ brew install hbase
</code></pre>

<h2>HDFSの構築と初期化</h2>

<p>あらかじめ、パスワードなしでSSHログインできるように、秘密鍵の作成と公開鍵の登録を済ませておきます。</p>

<h3>NameNode、DataNodeディレクトリの作成</h3>

<p>それぞれのディレクトリは、Homebrew管理下の/usr/local配下に構築します。</p>

<pre><code>$ mkdir -p /usr/local/var/dfs/nn
$ mkdir -p /usr/local/var/dfs/dn
</code></pre>

<h3>Hadoop設定ファイルの編集</h3>

<p>基本的には、Linux編とさほど変わりはありません。前回、前々回の記事を参考に次の設定ファイルを編集します。</p>

<ul>
<li>hadoop-env.sh</li>
<li>core-site.xml</li>
<li>hdfs-site.xml</li>
<li>yarn-site.xml</li>
<li>mapred-site.xml</li>
</ul>


<p>HADOOP_HOMEは/usr/local/opt/hadoop/libexecを指定します。hdfs-site.xmlの各ノードは、前述の/usr/local/var/dfsから始まるパスを指定します。</p>

<p>編集が無事終わったら、hdfsコマンドでNameNodeを初期化します。</p>

<pre><code>$ hdfs namenode -format
</code></pre>

<h2>HBaseの設定</h2>

<p>/usr/local/opt/hbase/conf に移動し、hbase-site.xmlを編集します。</p>

<pre><code>$ vi conf/hbase-site.xml
    :
&lt;property&gt;
    &lt;name&gt;hbase.rootdir&lt;/name&gt;
    &lt;value&gt;hdfs://localhost:9000/hbase&lt;/value&gt;
&lt;/property&gt;
&lt;property&gt;
    &lt;name&gt;dfs.replication&lt;/name&gt;
    &lt;value&gt;1&lt;/value&gt;
&lt;/property&gt;
</code></pre>

<h2>動作確認</h2>

<p>HDFSを起動させます。</p>

<pre><code>$ start-dfs.sh &amp;&amp; start-yarn.sh
</code></pre>

<p>それぞれ、Webインターフェールで正常に起動できているか確認を行います。</p>

<ul>
<li>Cluster Metrics: <a href="http://localhost:8088">http://localhost:8088</a></li>
<li>Namenode: <a href="http://localhost:50070">http://localhost:50070</a></li>
<li>Secondary NameNode: <a href="http://localhost:50090">http://localhost:50090</a></li>
</ul>


<p>続いて、HBaseを起動しブラウザで動作確認を行います。</p>

<pre><code>$ start-hbase.sh
</code></pre>

<ul>
<li>HBase: <a href="http://localhost:60010">http://localhost:60010</a></li>
</ul>


<h2>HBaseでエラーができる時の対処方法</h2>

<p>ZooKeeperがHBaseの管理下で起動されていない場合、次のコマンドで起動します。</p>

<pre><code>$ hbase-daemons.sh start zookeeper
$ netstat -an | grep 2181
    :                     # 確認
</code></pre>

<p>HDFSのノードやZooKeeperのメタ情報が参照できなくなった場合には、一度それぞれのノードを削除することエラーが解消される場合があります。</p>

<pre><code>$ hdfs dfs -rm -rf /hbase
$ zkCli
[zk: localhost:2181(CONNECTED) 0] rmr /hbase
</code></pre>

<h2>参考</h2>

<ul>
<li><a href="http://qiita.com/ma2k8/items/194311828775dedaaeba">MacOSX 10.9にHbaseインストール &ndash; Qiita</a></li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/03/15/hbase-0-dot-98-setup-on-linux/">HBase 0.98をSingle-Node ClusterのHDFSに構築する(Linux編)</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-03-15T09:55:04+09:00" pubdate data-updated="true">Mar 15<span>th</span>, 2014</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>　前回の続きで、Single-Node Clusterで構築したHDFS上にHBaseをインストールします。環境は次のとおりです。</p>

<ul>
<li>CentOS 6.5 x86_64</li>
<li>JDK 1.7.0 u51</li>
<li>Hadoop 2.2.0</li>
<li>HBase 0.98 Hadoop 2</li>
</ul>


<h2>HBaseのダウンロード</h2>

<p>　HBaseのDownloadページからリンクを辿って hbase-0.98.0-hadoop2-bin.tar.gz をダウンロードします。</p>

<pre><code>$ cd /usr/local/src
$ wget http://ftp.kddilabs.jp/infosystems/apache/hbase/hbase-0.98.0/hbase-0.98.0-hadoop2-bin.tar.gz
$ tar zxvf hbase-0.98.0-hadoop2-bin.tar.gz 
$ mv hbase-0.98.0-hadoop2 ../hbase
</code></pre>

<h2>hbase-site.xmlの設定</h2>

<p>　次の設定ファイルでHBaseのルートディレクトリを指定します。</p>

<pre><code>$ vi conf/hbase-site.xml
    :
&lt;property&gt;
    &lt;name&gt;hbase.rootdir&lt;/name&gt;
    &lt;value&gt;hdfs://localhost:9000/hbase&lt;/value&gt;
&lt;/property&gt;
&lt;property&gt;
    &lt;name&gt;dfs.replication&lt;/name&gt;
    &lt;value&gt;1&lt;/value&gt;
&lt;/property&gt;
</code></pre>

<p>また、念のためhbase-env.shでJAVA_HOMEを指定しておきましょう。</p>

<h2>起動と動作確認</h2>

<p>まず、HDFSを立ち上げます。</p>

<pre><code>$ start-dfs.sh &amp;&amp; start-yarn.sh
</code></pre>

<p>続いてHBaseを立ち上げます。</p>

<pre><code>$ start-hbase.sh
</code></pre>

<p>ブラウザから <a href="http://localhost:60010">http://localhost:60010</a> にアクセスして、Webインターフェースにアクセスできることを確認します。</p>

<p><img src="/images/20140315/hbase1.png" alt="HBase Web UII" /></p>

<p>ターミナルからHBaseシェルを起動します。</p>

<pre><code>$ hbase shell
2014-03-15 11:00:39,812 INFO  [main] Configuration.deprecation: hadoop.native.lib is deprecated. Instead, use io.native.lib.available
HBase Shell; enter 'help&lt;RETURN&gt;' for list of supported commands.
Type "exit&lt;RETURN&gt;" to leave the HBase Shell
Version 0.98.0-hadoop2, r1565492, Thu Feb  6 16:46:57 PST 2014
</code></pre>

<p>statusコマンドで状態を確認します。</p>

<pre><code>hbase(main):001:0&gt; status
SLF4J: Class path contains multiple SLF4J bindings.
SLF4J: Found binding in [jar:file:/usr/local/hbase/lib/slf4j-log4j12-1.6.4.jar!/org/slf4j/impl/StaticLoggerBinder.class]
SLF4J: Found binding in [jar:file:/usr/local/hadoop/share/hadoop/common/lib/slf4j-log4j12-1.7.5.jar!/org/slf4j/impl/StaticLoggerBinder.class]
SLF4J: See http://www.slf4j.org/codes.html#multiple_bindings for an explanation.
Java HotSpot(TM) 64-Bit Server VM warning: You have loaded library /usr/local/hadoop/lib/native/libhadoop.so.1.0.0 which might have disabled stack guard. The VM will try to fix the stack guard now.
It's highly recommended that you fix the library with 'execstack -c &lt;libfile&gt;', or link it with '-z noexecstack'.
2014-03-15 11:00:49,768 WARN  [main] util.NativeCodeLoader: Unable to load native-hadoop library for your platform... using builtin-java classes where applicable
1 servers, 0 dead, 2.0000 average load
</code></pre>

<p>HadoopとHBaseでロガーが競合しているため警告が沢山出ます&hellip;. が、今回は無視します。テーブルとデータが作成できるかテストします。</p>

<pre><code>hbase(main):001:0&gt; create 'testtable', 'fam'
0 row(s) in 2.6850 seconds

=&gt; Hbase::Table - testtable
hbase(main):002:0&gt; put 'testtable', 'row1', 'fam:col', 'val'
0 row(s) in 0.4660 seconds
</code></pre>

<p>ブラウザから <a href="http://localhost:50070">http://localhost:50070</a> にアクセスし、Browse the filesystem でHBaseのディレクトリが作成されていれば成功です。
<img src="/images/20140315/hbase2.png" alt="hbase datanode" /></p>

<p>次回は、Homebrewを使って同じ環境をOS Xで再現したいと思います。</p>

<h2>参考</h2>

<ul>
<li><a href="http://oss.infoscience.co.jp/hbase/book.html#hbase.site">Apache HBase ブック</a></li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/03/14/hadoop-2-dot-2-setup-on-linux/">Hadoop 2.2をSingle-Node Clusterでインストールする(Linux編)</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-03-14T12:02:09+09:00" pubdate data-updated="true">Mar 14<span>th</span>, 2014</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>HBaseをローカルで動かすためにHDFSを構築します。Standaloneモードで起動する場合、HDFSは不要となりますが、そうとは言えHadoopとの関係は切っても切り離せません。そこでHadoopエコシステムの学習も含めHDFS上にHBaseを構築してみたいと思います。環境は次のとおりです。</p>

<h2>環境</h2>

<ul>
<li>CentOS 6.5 x86_64</li>
<li>JDK 1.7.0 u51</li>
<li>Hadoop 2.2.0</li>
</ul>


<h2>Hadoopユーザーの作成</h2>

<p>まず、OSにHadoopユーザーを作成します。</p>

<pre><code># groupadd hadoop
# useradd -g hadoop hadoop
</code></pre>

<p>続いて、パスワード無しでSSH接続できるように鍵の作成を行います。</p>

<pre><code>$ ssh-keygen
Generating public/private rsa key pair.
Enter file in which to save the key (/home/hadoop/.ssh/id_rsa): ↵ 
Enter passphrase (empty for no passphrase): ↵ 
Enter same passphrase again: ↵ 
Your identification has been saved in /home/hadoop/.ssh/id_rsa.
Your public key has been saved in /home/hadoop/.ssh/id_rsa.pub.
The key fingerprint is:
36:93:c4:83:fa:39:52:de:d1:f1:ed:19:6a:c3:97:22 hadoop@centos.local
The key's randomart image is:
+--[ RSA 2048]----+
     :
$ cd .ssh
$ cat id_rsa.pub &gt;&gt; authorized_keys
$ chmod 600 authorized_keys
$ chmod 400 id_rsa
</code></pre>

<p>鍵の作成が終わったら、SSHでパスワードのプロンプトが表示されずにログインできるか確認します。</p>

<pre><code>$ ssh localhost
The authenticity of host 'localhost (::1)' can't be established.
RSA key fingerprint is 27:05:7f:46:bd:cd:10:7d:d8:2c:38:60:21:46:05:14.
Are you sure you want to continue connecting (yes/no)? yes
Warning: Permanently added 'localhost' (RSA) to the list of known hosts.
Last login: Fri Mar 14 13:56:43 2014 from 10.0.2.2
$
</code></pre>

<p>無事ログインできれば成功です。</p>

<h2>Hadoopのダウンロード</h2>

<p>HadoopウェブサイトのDownload Hadoopからリンクを辿ってhadoop-2.2.0.tar.gzをダウンロードします。ダウンロードが完了したら/usr/local/hadoopに展開します。</p>

<pre><code>$ /usr/local/src
$ wget http://ftp.jaist.ac.jp/pub/apache/hadoop/common/hadoop-2.2.0/hadoop-2.2.0.tar.gz 
$ tar zxvf hadoop-2.2.0.tar.gz
$ mv hadoop-2.2.0 ../hadoop
</code></pre>

<h2>HDFSの構築</h2>

<p>Namenode、Datanodeを格納するディレクトリを作成します。この設定は、後述のhdfs-site.xmlで指定できます。</p>

<pre><code># mkdir -p /var/dfs/nn  # namenode
# mkdir -p /var/dfs/dn  # datanode
# chown -R hadoop:hadoop /var/dfs
</code></pre>

<h3>環境変数の設定</h3>

<p>.bash_profileに次のHadoop用の環境変数を設定します。</p>

<pre><code>$ vi ~/bash_profile
export HADOOP_COMMON_HOME=/usr/local/hadoop
export HADOOP_HDFS_HOME=$HADOOP_COMMON_HOME

export HADOOP_MAPRED_HOME=$HADOOP_COMMON_HOME
export YARN_HOME=$HADOOP_COMMON_HOME

export PATH=$HADOOP_COMMON_HOME/sbin:$HADOOP_COMMON_HOME/bin:$PATH
</code></pre>

<p>続いて、HADOOP_HOME/etc/hadoopに移動し次の環境変数を設定します。</p>

<pre><code>$ cd /usr/local/hadoop/etc/hadoop
$ vi hadoop-env.sh 
export JAVA_HOME=/usr/java/default
export HADOOP_COMMON_LIB_NATIVE_DIR=$HADOOP_HOME/lib/native
export HADOOP_OPTS="$HADOOP_OPTS -Djava.library.path=$HADOOP_HOME/lib"
</code></pre>

<h3>Hadoop設定ファイルの編集</h3>

<p>Hadoop設定ファイルのそれぞれに次の設定を追加します。</p>

<p>core-site.xml (基本情報の設定)</p>

<pre><code>&lt;property&gt;
  &lt;name&gt;fs.default.name&lt;/name&gt;
  &lt;value&gt;hdfs://localhost:9000&lt;/value&gt;
&lt;/property&gt; 
</code></pre>

<p>hdfs-site.xml (NameNodeとDataNodeの設定)</p>

<pre><code>&lt;property&gt;
  &lt;name&gt;dfs.replication&lt;/name&gt;
  &lt;value&gt;1&lt;/value&gt;
&lt;/property&gt;

&lt;property&gt;
  &lt;name&gt;dfs.namenode.name.dir&lt;/name&gt;
  &lt;value&gt;file:///var/dfs/nn&lt;/value&gt;
&lt;/property&gt;

&lt;property&gt;
  &lt;name&gt;dfs.datanode.data.dir&lt;/name&gt;
  &lt;value&gt;file:///var/dfs/dn&lt;/value&gt;
&lt;/property&gt;
</code></pre>

<p>yarn-site.xml (ResourceManager、NodeManager、History Serverの設定)</p>

<pre><code>&lt;property&gt;
  &lt;name&gt;yarn.nodemanager.aux-services&lt;/name&gt;
  &lt;value&gt;mapreduce_shuffle&lt;/value&gt;
&lt;/property&gt;

&lt;property&gt;
  &lt;name&gt;yarn.nodemanager.aux-services.mapreduce.shuffle.class&lt;/name&gt;
  &lt;value&gt;org.apache.hadoop.mapred.ShuffleHandler&lt;/value&gt;
&lt;/property&gt;
</code></pre>

<p>mapred-site.xml (MapReduce、JobHistory Serverの設定)</p>

<pre><code>$ cp mapred-site.xml.template mapred-site.xml
$ vi mapred-site.xml
    :
&lt;property&gt;
  &lt;name&gt;mapreduce.framework.name&lt;/name&gt;
  &lt;value&gt;yarn&lt;/value&gt;
&lt;/property&gt; 
</code></pre>

<h3>NameNodeの初期化</h3>

<p>次のコマンドで、NameNodeの初期化を行います。</p>

<pre><code>$ hdfs namenode -format
14/03/14 15:37:42 INFO namenode.NameNode: STARTUP_MSG:
/************************************************************
STARTUP_MSG: Starting NameNode
STARTUP_MSG:   host = centos/127.0.0.1
STARTUP_MSG:   args = [-format]
STARTUP_MSG:   version = 2.2.0
STARTUP_MSG:   classpath = /usr/local/hadoop/etc/hadoop:/usr/local/hadoop/share/hadoop/common/lib/jetty-ut
    :
SHUTDOWN_MSG: Shutting down NameNode at centos/127.0.0.1
************************************************************/
</code></pre>

<h2>Hadoopの起動とプロセスの確認</h2>

<p>次の起動スクリプトでHadoopを起動します。(start-all.sh は、非推奨になったようです)</p>

<pre><code>$ start-dfs.sh
14/03/14 15:45:39 WARN util.NativeCodeLoader: Unable to load native-hadoop library for your platform... using builtin-java classes where applicable
Starting namenodes on [localhost]
localhost: starting namenode, logging to /usr/local/hadoop/logs/hadoop-hadoop-namenode-centos.out
localhost: starting datanode, logging to /usr/local/hadoop/logs/hadoop-hadoop-datanode-centos.out
Starting secondary namenodes [0.0.0.0]
</code></pre>

<p>64bit OSで実行すると、NativeCodeLoaderの警告文が出ます。これはHadoopのNativeライブラリが32bitを使っているためです。</p>

<pre><code>$ start-yarn.sh
starting yarn daemons
starting resourcemanager, logging to /usr/local/hadoop/logs/yarn-hadoop-resourcemanager-centos.out
localhost: starting nodemanager, logging to /usr/local/hadoop/logs/yarn-hadoop-nodemanager-centos.out
</code></pre>

<p>起動が完了したら、jpsコマンドでプロセスを確認します。jpsが見つからない場合は JAVA_HOME/binにパスを通してください。</p>

<pre><code>$ jps
7529 SecondaryNameNode
8083 Jps
7684 ResourceManager
7792 NodeManager
7255 NameNode
</code></pre>

<p>停止するには、それぞれ逆の stop-dfs.sh、stop-yarn.sh を実行します。</p>

<h2>動作確認</h2>

<p>各ノードの状態は、次のWebインターフェースで確認できます。</p>

<ul>
<li>Cluster Metrics: <a href="http://localhost:8088">http://localhost:8088</a>
<img src="/images/20140314/hadoop1.png" alt="cluster metrics" /></li>
<li>Namenode: <a href="http://localhost:50070">http://localhost:50070</a>
<img src="/images/20140314/hadoop2.png" alt="namenode" /></li>
<li>Secondary NameNode: <a href="http://localhost:50090">http://localhost:50090</a>
<img src="/images/20140314/hadoop3.png" alt="secondary namenode" /></li>
</ul>


<p>次は、HBaseのインストール手順をまとめたいと思います。</p>

<h2>参考</h2>

<ul>
<li><a href="http://alanxelsys.com/2014/02/01/hadoop-2-2-single-node-installation-on-centos-6-5/">Hadoop 2.2 Single Node Installation on CentOS 6.5 | AJ&rsquo;s Data Storage Tutorials</a></li>
<li><a href="http://bigdatahandler.com/2013/11/02/installing-single-node-hadoop-2-2-0-on-ubuntu/">Installing single node Hadoop 2.2.0 on Ubuntu « BigData Handler</a></li>
<li><a href="http://www.ercoppa.org/Linux-Install-Hadoop-220-on-Ubuntu-Linux-1304-Single-Node-Cluster.htm">Linux Install Hadoop 2.2.0 on Ubuntu Linux 13.04 (Single-Node Cluster)</a></li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/03/07/java-deploy-for-heroku/">JavaアプリをHerokuにデプロイする</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-03-07T10:31:53+09:00" pubdate data-updated="true">Mar 7<span>th</span>, 2014</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>HerokuのPaaSは、Railsの他にScala、PHPなど、様々な言語に対応しています。もちろん、Javaアプリケーションを稼働させることができます。Javaの場合、デプロイは次のような流れで行なわれます。</p>

<ol>
<li>Mavenプロジェクトの作成</li>
<li>Gitリポジトリにpush</li>
<li>Mavenビルド (Heroku)</li>
<li>Procfileの実行 (Heroku)</li>
</ol>


<p>この様に、Railsのデプロイと比べると、Javaの場合は少しだけコツが必要です。今回は、その方法をめとめておきます。</p>

<h2>JDKのバージョン指定</h2>

<p>HerokuのJDKは、デフォルトでOpenJDK 1.6が使用されます。Maven Compilerプラグインで1.7を指定している場合は、pom.xmlと同じ階層に system.propertiesを作成します。内容は次のとおりです。</p>

<pre><code>java.runtime.version=1.7
</code></pre>

<p>こうすることで、JDK1.7の構文で書かれたプロジェクトをビルドできるようになります。</p>

<h2>Jetty Runnerプラグインの設定</h2>

<p>HerokuでJavaアプリを起動させるために、コマンドラインからwarプロジェクトを起動できるようにします。それにはpom.xmlに次のプラグインを追加します。</p>

<pre><code>&lt;plugin&gt;
    &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;
    &lt;artifactId&gt;maven-dependency-plugin&lt;/artifactId&gt;
    &lt;version&gt;2.8&lt;/version&gt;
    &lt;executions&gt;
        &lt;execution&gt;
            &lt;phase&gt;package&lt;/phase&gt;
            &lt;goals&gt;
                &lt;goal&gt;copy&lt;/goal&gt;
            &lt;/goals&gt;
            &lt;configuration&gt;
                &lt;artifactItems&gt;
                    &lt;artifactItem&gt;
                        &lt;groupId&gt;org.eclipse.jetty&lt;/groupId&gt;
                        &lt;artifactId&gt;jetty-runner&lt;/artifactId&gt;
                        &lt;version&gt;9.1.2.v20140210&lt;/version&gt;
                        &lt;destFileName&gt;jetty-runner.jar&lt;/destFileName&gt;
                    &lt;/artifactItem&gt;
                &lt;/artifactItems&gt;
            &lt;/configuration&gt;
        &lt;/execution&gt;
    &lt;/executions&gt;
&lt;/plugin&gt;
</code></pre>

<p>これで、Mavenのpackageフェーズでtargetディレクトリにjetty-runner.jarがコピーされます。ローカルで起動するには次のコマンドを実行します。</p>

<pre><code>java -cp target/dependency/* -jar target/depencency/jetty-runner.jar --port &lt;PORT&gt; target/*.war
</code></pre>

<p>warプロジェクトを直接アップロードしてデプロイする方法もあるみたいですが調べきれてません&hellip;</p>

<h2>Procfileの作成</h2>

<p>先ほどの system.propertiesと同じディレクトリ階層に起動スクリプトのProcfileを作成します。jetty-runner.jarを使ったコマンドは次のとおりです。</p>

<pre><code>web: java $JAVA_OPTS -jar target/dependency/jetty-runner.jar --port $PORT target/*.war
</code></pre>

<h2>Herokuのプロセス確認</h2>

<p>デプロイが完了したら、プロセスが立ち上がっているか確認しましょう。まず、herokuにログインします。</p>

<pre><code>$ heroku login
Enter your Heroku credentials.
Email: &lt;your email&gt;
Password (typing will be hidden):
Authentication successful.
</code></pre>

<p>heroku psコマンドでプロセスを確認します。</p>

<pre><code>$ heroku ps --app mogi === web (1X): `java $JAVA_OPTS -jar target/dependency/jetty-runner.jar --port $PORT target/*.war`
web.1: idle 2014/03/06 11:20:05 (~ 23h ago)
</code></pre>

<h2>まとめ</h2>

<p>個人的にはProcfileの作成とJetty Runnerプラグインの設定でハマりました。HerokuのGitリポジトリにpushすると、自動的にMavenのビルドが始まるので、このような設定が必要だとは思いもよりませんでした。最初からオフィシャルのマニュアル読めよ！って話ですね。</p>

<h2>参考</h2>

<ul>
<li><a href="http://java.heroku.com">Heroku Java</a></li>
<li><a href="http://d.hatena.ne.jp/beercan/20110912/1315835179">全くの初心者だが Heroku の Java サンプルを試してみた。 &ndash; 酒浸りの日々</a></li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/03/06/hello-gist/">Hello Gist!!</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-03-06T12:55:56+09:00" pubdate data-updated="true">Mar 6<span>th</span>, 2014</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>　OctopressにGistのスニペットを貼ってみます。つまりテスト投稿です。構文は、<code>｛% gist gist_id [filename] %}</code> です。gist_idを指定すると<code>｛% gist 9382060 %}</code>の様になります。では、さっそく&hellip;</p>

<div><script src='https://gist.github.com/9382060.js'></script>
<script type="text/javascript">$(".gist-file table tr td.line-numbers").remove();</script>
<noscript><pre><code>public HelloGist {

  public static final String main(String[] args) {
    System.out.println(&quot;Hello Gist :)&quot;);  
  }

}</code></pre></noscript></div>


<p>うむ。かなり良い感じです。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/03/05/deamon-on-cygwin/">Unixのサーバ群をCygwin上にインストールする</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-03-05T15:42:49+09:00" pubdate data-updated="true">Mar 5<span>th</span>, 2014</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>UnixのデーモンプログラムをCygwinで動かしてみます。インストールに関しては、HomebrewやYumで一発OKなほど洗練されているとは言えません。そこがCygwinの楽しみの一つでもあるのですが、たまに躓く自分のために、覚書として残しておきます。</p>

<ul>
<li>SSH 6.5</li>
<li>Apache 2.2</li>
<li>Mysql 5.5</li>
</ul>


<h2>Windowsサービスの登録方法</h2>

<p>Windowsのサービスに登録するには、cygrunsrvコマンドを使います。このコマンドは、Linuxのinit.dスクリプトとchkconfigの役目を果たします。コマンドの書式は次のとおりです。</p>

<pre><code>$ cygrunsrv --install &lt;app_name&gt; --path &lt;app_path&gt; [OPTIONS...]
</code></pre>

<h2>Cygrunsrv</h2>

<p>Unixのデーモンをバックグラウンドで動かすためにCygserverの設定を行います。Cygserverは、Windowsで提供されていなセマフォやメッセージキューなどのプロセス間通信を支援します。まず、Cygwinのインストールが完了したら、Windowsのシステム環境変数に CYGWIN=server する必要があります。続いて、次のコマンドでCygserverの設定を行います。</p>

<pre><code>$ cygserver-config
Generating /etc/cygserver.conf file


Warning: The following function requires administrator privileges!
Do you want to install cygserver as service?
(Say "no" if it's already installed as service) (yes/no) yes

The service has been installed under LocalSystem account.
To start it, call `net start cygserver' or `cygrunsrv -S cygserver'.

Further configuration options are available by editing the configuration
file /etc/cygserver.conf. Please read the inline information in that
file carefully. The best option for the start is to just leave it alone.
    :
Basic Cygserver configuration finished. Have fun!
</code></pre>

<p>Windowsのサービス一覧に CYGWIN cygserver が追加されていることを確認します。</p>

<h2>SSH</h2>

<p>Opensshでは、3.3以降からデーモンプロセスを、特権を持たないsshdというユーザーに閉じ込めることで、セキュリティーを担保するようになりました。Cygwinに関しても、しかりでsshdというOSのローカルユーザを別途作成する必要があります。この作業は、対話式のssh-host-configスクリプトで行います。なお特権を分離するため下記の問に yes と応えます。</p>

<pre><code>$ ssh-host-config
    : 
*** Query: Should privilege separation be used? (yes/no) yes
</code></pre>

<p>Windowsのサービスに登録するには、下記の質問にyesと応えます。サービス名はデフォルトのままにします。</p>

<pre><code>*** Query: Do you want to install sshd as a service?
*** Query: (Say "no" if it is already installed as a service) (yes/no) yes
*** Query: Enter the value of CYGWIN for the daemon: []
    :
</code></pre>

<p>ここで、WIndowsのサービスを起動するcyg_serverユーザを作成するか尋ねられますが、WindowsのSYSTEMローカルアカウントで代用できます。なので、今回はcyg_serverユーザを作らないままインストールを進めます。</p>

<pre><code>*** Info: This script plans to use 'cyg_server'.
*** Info: 'cyg_server' will only be used by registered services.
*** Query: Do you want to use a different name? (yes/no) no

*** Query: Create new privileged user account 'cyg_server'? (yes/no) no
*** ERROR: There was a serious problem creating a privileged user.
*** Query: Do you want to proceed anyway? (yes/no) yes
*** Warning: Expected privileged user 'cygwin' does not exist.
*** Warning: Defaulting to 'SYSTEM'

*** Info: The sshd service has been installed under the LocalSystem 
    :
</code></pre>

<p>スクリプトが正常に終了したら、メッセージに従って下記のコマンド、またはWindowsサービスから起動しSSHログインできるか確認します。</p>

<pre><code>$ cygrunsrv --start sshd 
</code></pre>

<h2>Apache2</h2>

<p>Apacheのインストールが完了したら、httpd.confの設定を行います。インストール直後はServerNameがコメントアウトされているので、正しいサーバー名を設定してあげます。</p>

<pre><code>$ hostname --fqdn
win7.local   &lt;--- サーバー名

$ /usr/sbin/apachectl2 configtest
Syntax OK
</code></pre>

<p>設定が完了したら、起動するか確認します。</p>

<pre><code>$ /usr/sbin/apachectl2 start
    or
$ /usr/sbin/httpd2 -k start
</code></pre>

<p>Apacheの起動にはCygserverの設定とCYGWIN環境変数の設定が必要です。1464 Bad system call などとエラーが出た場合は、これらが正しく設定されているか確認してみてください。</p>

<p>cygrunsrvでサービスに登録します。</p>

<pre><code>$ cygrunsrv --install httpd --path /usr/sbin/httpd --args '-k' --disp 'CYGWIN httpd'
</code></pre>

<p>Windowsのサービス一覧から起動できれば成功です。</p>

<h2>MySQL</h2>

<p>MySQLをローカルで起動するにはサーバーとクライアントの両方が必要です。クライアントのインストールが抜けていると、起動時に my_print_defaults が見つからずエラーになります。setup.exe のインストールが完了したら、DBの初期化を行います。</p>

<pre><code>$ /usr/bin/mysql_installdb
</code></pre>

<p>デフォルトでは /var/lib/mysql にデータベースが作成されます。変更したい場合は &mdash;datadir=<path> で指定します。データベースの初期化が完了したらメッセージにしたがって mysql.server スクリプトをコピーしておきます。</p>

<pre><code>$ cp /usr/share/mysql/mysql.server /usr/bin/
$ chmod +x /usr/bin/mysql.server
</code></pre>

<p>次のコマンドで起動と、mysqlクライアントから接続できるか確認します。</p>

<pre><code>$ mysql.server start
Starting MySQL...... SUCCESS!
$ mysql -uroot -p
</code></pre>

<p>最後にWindowsのサービスに登録します</p>

<pre><code>$ cygrunsrv --install mysqld --path /usr/bin/mysql_safe --args '--datadir=/var/lib/mysql --pid-file=/var/lib/mysql/&lt;srv_name&gt;.pid
</code></pre>

<h2>参考</h2>

<ul>
<li><a href="https://www.citi.umich.edu/u/provos/ssh/privsep-j.html">特権分離 (Privilege Separated) OpenSSH</a></li>
<li><a href="http://www.sixnine.net/cygwin/translation/cygwin-ug-net/using-cygserver.html">3.6. Cygserver</a></li>
<li><a href="http://komoriyuichi.web.fc2.com/cygwin/apache2.html">Cygwin で Apache2 をサービスとして起動</a></li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/03/04/my-favorite-eclipse-plugin/">重宝しているEclipse Pluginたち</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-03-04T14:32:30+09:00" pubdate data-updated="true">Mar 4<span>th</span>, 2014</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Java屋として、仕事から普段まで切っては切れない縁のEclipse。intelliJ IDEAに乗り換えようと思った時も何度かありましたが、いまだEclipseを使っています。(intelliJ高い&hellip;)</p>

<p>今回は、あると開発が便利になるプラグインを4つ紹介したいと思います。</p>

<ol>
<li>Terminalプラグイン</li>
<li>Glanceプラグイン</li>
<li>Quick Junitプラグイン</li>
<li>Eclipse Color Themeプラグイン</li>
</ol>


<h2><a href="https://code.google.com/p/elt/">Terminalプラグイン</a></h2>

<p><img src="/images/20140305/terminal.png" alt="Terninaml" />
　その名の通り、ターミナルエミュレータで開発元はGoogle,incです。Aptana StudioのRailsプロジェクトで存在を知ったんですが、Googleらしくシンプルで非常に使いやすく設計されています。</p>

<p>　Javaだとコードを書いてMavenでテスト実行、Gitで差分を確認なんかをやろうとしても、キーボードから手を話してマウスでメニューを辿って&hellip;という煩わしさから解放されます。ダントツ一位でおすすめのプラグインです。</p>

<h2><a href="https://code.google.com/p/eclipse-glance/">Glanceプラグイン</a></h2>

<p><img src="/images/20140305/glance.png" alt="Glance" /></p>

<p>　Eclipseの非力な検索を改善してくれるプラグインです。Eclipse標準のプラグインはモーダルダイアログで、検索結果がダイアログに隠れてしまうこともしばしば。これは、強力なインクリメンタルサーチでファイル以外にもEclipseのペインも検索対象にしてくれます。解説は、<a href="http://did2memo.net/2012/11/06/eclipse-iterative-search-plugin-glance/">情報科学屋さんを目指す人のメモ</a>が詳しいので参考にしてみてください。</p>

<h2><a href="http://quick-junit.sourceforge.jp">Quick Junitプラグイン</a></h2>

<p>　その名の通り、JUnitの操作を高速にするプラグインです。⌘ + 9でテスティングペア間を移動、⌘ + 0でJUnitを実行できます。</p>

<h2><a href="http://eclipsecolorthemes.org">Eclipse Color Themeプラグイン</a></h2>

<p><img src="/images/20140305/color.png" alt="Color" /></p>

<p>　テキストエディタに好みのカラーテーマを適用するプラグインです。VimやEmacsなどで有名なカラースキームが<a href="http://eclipsecolorthemes.org">配布</a>されています。私の場合はtomasr/molokai風のOvlibionというテーマを適用しています。</p>

<p>その他、Spring IDEやm2eなど外せないプラグインも数多くありますが、１つずつ上げていくと限がないので今回はここまで。</p>

<h2>参考</h2>

<ul>
<li><a href="http://did2memo.net/2012/11/06/eclipse-iterative-search-plugin-glance/">Eclipseを改善するインクリメンタルサーチプラグイン「Glance」がオススメ！</a></li>
<li><a href="http://www.atmarkit.co.jp/ait/articles/1008/02/news095.html">ユカイ、ツーカイ、カイハツ環境！（16）：単体テストを“神速”化するQuick JUnitとMockito &ndash; ＠IT</a></li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/03/01/java-ci-3/">Java CI環境(Jenkins+α)構築のおさらい その3 Jenkins構築編</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-03-01T11:22:33+09:00" pubdate data-updated="true">Mar 1<span>st</span>, 2014</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>SVN、Mavenリポジトリの構築が終わったので、いよいよJenkninsのインストールに移ります。SVN、Mavenの構築が正しくできていれば、Jenkinsそのもののインストールはさほど難しいものではありません。インストールする環境は下記のとおりです。</p>

<h2>環境</h2>

<ul>
<li>CentOS 6.5 (x86_64)</li>
<li>Subversion 1.7.4 (+Apache 2.2 WebDAV)</li>
<li>Nexus OSS 2.7.1-01</li>
<li>Jenkins 1.551</li>
</ul>


<h2>Jenkinsのインストール</h2>

<p>Yumでインストールするので、Jenkinsの<a href="http://pkg.jenkins-ci.org/redhat/jenkins.repo">サイト</a>から.repoファイルを取得し、ローカルに取り込みます。</p>

<pre><code># wget -O /etc/yum.repos.d/jenkins.repo http://pkg.jenkins-ci.org/redhat/jenkins.repo
# rpm --import http://pkg.jenkins-ci.org/redhat/jenkins-ci.org.key
# yum clean all
# yum install -y jenkins
</code></pre>

<p>インストールが終了したら自動起動の設定を行います。</p>

<pre><code># cd /etc/init.d/
# chkconfig --add jenkins
# chkconfig jenkins on
# service jenkins start 
Starting Jenkins                                           [  OK  ]
</code></pre>

<p>ブラウザで <a href="http://localhost:8080/">http://localhost:8080/</a> にアクセスし、次の画面が表示されていれば成功です。</p>

<p><img src="/images/20140301/jenkins1.png" alt="Jenkins Capture" /></p>

<h2>プラグインのインストール</h2>

<p>Jenkinsの管理 > プラグインの管理 > インストール済みから次のプラグインがインストールされていることを確認します。インストールされていない場合は、利用可能タブからインストールします。</p>

<ul>
<li>Subversion Plug-in</li>
<li>Maven Integration plugin</li>
</ul>


<h2>Jobの作成</h2>

<p>新規Job作成 からジョブ名を入力し、Maven2/3プロジェクトのビルドを作成します。ソースコード管理でSVNのリポジトリを指定します。
(あらかじめ、JDK と Mavenの設定をJenkinsの管理 > システムの管理 で済ませておきます。)
<img src="/images/20140301/jenkins2.png" alt="SCM" /></p>

<p>続いて、Mavenビルドのゴールを設定します。ビルドのゴールには、maven-release-pluginの prepare、perform を続けて入力します。</p>

<p><img src="/images/20140301/jenkins3.png" alt="Maven" /></p>

<h2>ビルド実行</h2>

<p>Jobの一覧からビルドを実行します。すると、Jenkinsで設定したとおり、SCMからソースコードをチェックアウト、その後Mavenプロジェクトのビルドとデプロイ、さらにSVNのタグ付けまでを一気に行います。ビルドが成功したら、W(ether)の列に晴れのアイコンが表示されているはずです。
<img src="/images/20140301/jenkins4.png" alt="Build" /></p>

<p>最後に、SVN、Nexusそれぞれのリポジトリに成果物がリリースされていることを確認します。</p>

<h2>おわりに</h2>

<p>数回にわたってCI環境を構築してきました。NexusへのデプロイやMaven Releaseプラグインなど、普段仕事で使ってはいるものの、騙しだましできたのが自分で構築したことで基礎しっかりとを理解することができたと思います。</p>

<p>また、SCM、Nexus、Jenkinsを組み合わせることで開発にリズムが生まれました。Jenkinsは、様々な作業を自動化出来る便利なツールです。良いアイデアを思いついた際には改めて記事に残したいと思います。</p>

<h2>参考</h2>

<p><a href="http://green-tea-stalk.blogspot.jp/2012/09/maven-jenkins-sonatype-nexus.html">徒然日記: Maven + Jenkins + Sonatype Nexus でビルド環境を構築</a>
<a href="http://oscasierra.net/2013/05/jenkins-to-redhat/">CentOS/RedHatにJenkinsをインストールする手順 (yum, RPM) | OSCALOG</a></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/02/23/java-ci-2/">Java CI環境(Jenkins+α)構築のおさらい その2 Mavenリポジトリ構築編</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-02-23T10:23:41+09:00" pubdate data-updated="true">Feb 23<span>rd</span>, 2014</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>前回に引き続きJennkinsでJavaのCI環境を構築していきます。構築する環境は以下の通りです。</p>

<h2>環境</h2>

<ul>
<li>CentOS 6.5 (x86_64)</li>
<li>Subversion 1.7.4 (+Apache 2.2 WebDAV)</li>
<li>Nexus OSS 2.7.1-01</li>
<li>Jenkins 1.551</li>
</ul>


<h2>Nexus OSSのインストール</h2>

<p>NexusはMavenの成果物管理ツールとして最も多く使われているプロダクトです。まず、Nexusをインストールする前にOSの起動ユーザを作成します。</p>

<pre><code># groupadd nexus
# useradd -g nexus -s /bin/bash nexus
</code></pre>

<p>Nexus OSSのバンドル版をSonatypeのページからダウンロードします。</p>

<pre><code># cd /usr/local/src
# wget http://www.sonatype.org/downloads/nexus-latest-bundle.tar.gz
</code></pre>

<p>ダウンロードが完了したら、tar.gzを/usr/localに解凍し権限を変更します。</p>

<pre><code># tar zxvf nexus-latest-bundle.tar.gz 
# mv nexus-[version] sonatype-work /usr/local
# choen -R nexus. nexus-[version] sonatype-work
</code></pre>

<p>続いて起動スクリプトの編集と自動起動の設定を行います。(JAVA_HOMEが設定されているものとします)</p>

<pre><code># cd /etc/init.d/
# cp /usr/local/nexus/bin/nexus .
# chmod 755 ./nexus
# vi ./nexus
    :
# Set this to the root of the Nexus installation
NEXUS_HOME="/usr/local/nexus"
    :
# NOTE - This will set the user which is used to run the Wrapper as well as
#  the JVM and is not useful in situations where a privileged resource or
#  port needs to be allocated prior to the user being changed.
RUN_AS_USER=nexus
</code></pre>

<p>chkconfigに/etc/init.d/nexusを追加しサーバーを起動します。</p>

<pre><code># cd /etc/init.d/
# chkconfig --add nexus
# chkconfig --levels 345 nexus on
# service nexus start
Starting Sonatype Nexus...
</code></pre>

<p>ブラウザで <a href="http://localhost:8081/nexus">http://localhost:8081/nexus</a> にアクセスし次の画面が表示されていれば成功です。</p>

<p><img src="/images/20140222/nexus_capture.png" alt="Nexus Capture" /></p>

<h2>Maven設定ファイルの編集</h2>

<p>Mavenプロジェクトでデプロイを行う際、Nexusにアクセスできるユーザが必要です。Nexusイントール時に作成されている既存ユーザから、今回はdeploymentユーザを使ってデプロイを行います。既存ユーザと役割は下記のとおりです。</p>

<ul>
<li>admin: 管理者ユーザ。Nexusの管理とデプロイなど全ての機能が利用可能です</li>
<li>deploymenet: デプロイユーザ。リポジトリの参照とデプロイが可能です</li>
<li>anonymous: 匿名ユーザ。publicリポジトリの参照がです</li>
</ul>


<p>$M2_HOME/con/settings.xml にdeploymenetユーザを追加します。</p>

<pre><code>$ vi $M2_HOME/conf/settings.xml
    :
&lt;servers&gt;
  &lt;server&gt;
    &lt;id&gt;nexus&lt;/id&gt;
    &lt;username&gt;deployment&lt;/username&gt;
    &lt;password&gt;deployment123&lt;/password&gt;
  &lt;/server&gt;
&lt;/servers&gt;
</code></pre>

<h2>Mavenプロジェクトでデプロイの設定</h2>

<p>pom.xmlのデプロイ管理の要素に、SnapthotsとReleasesリポジトリの設定を追加します。具体的には下記のようになります。また、リポジトリのIDは前述のID(nexus)と一致している必要があります。</p>

<pre><code>&lt;distributionManagement&gt;
  &lt;repository&gt;
    &lt;id&gt;nexus&lt;/id&gt;
    &lt;name&gt;Releases&lt;/name&gt;
    &lt;url&gt;http://localhost:8081/nexus/content/repositories/releases/&lt;/url&gt;
  &lt;/repository&gt;
  &lt;snapshotRepository&gt;
    &lt;id&gt;nexus&lt;/id&gt;
    &lt;name&gt;Snapshots&lt;/name&gt;
    &lt;url&gt;http://localhost:8081/nexus/content/repositories/snapshots/&lt;/url&gt;
  &lt;/snapshotRepository&gt;
&lt;/distributionManagement&gt;
</code></pre>

<h2>Maven Plug-inでリリース</h2>

<p>ここまで準備ができたら、最後にMavenのリリースプラグインを使ってデプロイを行います。まずは、下記のコマンドでSnapshotsリポジトリに配備出来るか確認します。</p>

<pre><code>$ mvn deploy
</code></pre>

<p>Mavenのrelease:prepareおよびrelease:performを実行することで、SCMでリリースビルドのタグ付け、さらにNexusのReleaseリポジトリにデプロイまで一括して行えます。
まず、release:prepareの質問に回答しリリースの準備を行います。</p>

<pre><code>$ mvn release:prepare
    :
[INFO] Checking dependencies and plugins for snapshots ...
What is the release version for "project"? (name.satoshi.yamamoto:project) 1.0: :
What is SCM release tag or label for "project"? (name.satoshi.yamamoto:project) project-1.0: :
What is the new development version for "project"? (name.satoshi.yamamoto:project) 1.1-SNAPSHOT: :
</code></pre>

<p>最後にrelease:performでReleaseリポジトリにデプロイします。</p>

<pre><code>$ mvn release:perform
     :
[INFO] Uploaded: http://localhost:8081/nexus/content/repositories/releases/name/satoshi/yamamoto/project/1.0/project-1.0.jar (3 KB at 8.4 KB/sec)
     :
[INFO] ------------------------------------------------------------------------
[INFO] BUILD SUCCESS
[INFO] ------------------------------------------------------------------------
[INFO] Total time: 14.967 s
[INFO] Finished at: 2014-02-27T15:04:22+09:00
[INFO] Final Memory: 9M/28M
[INFO] ------------------------------------------------------------------------
</code></pre>

<p>以上でMavenリポジトリ編を終わります。ここまで来れば後はJenkinsのインストールとJobを作成するのみです。ふぅぅ&hellip;。</p>

<h2>参考</h2>

<ul>
<li><a href="http://news.mynavi.jp/column/ide/129/">イマドキのIDE事情 (129) リポジトリ管理ツール「Nexus」でMavenをさらに活用しよう! | マイナビニュース</a></li>
<li><a href="http://www.in-vitro.jp/blog/index.cgi/Maven/20081007_01.htm">試験管のなかのコード :: Maven2 の release プラグインにチャレンジ</a></li>
<li><a href="http://green-tea-stalk.blogspot.jp/2012/09/maven-jenkins-sonatype-nexus.html">Maven + Jenkins + Sonatype Nexus でビルド環境を構築</a></li>
</ul>

</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/blog/page/3/">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>About Me</h1>
	<p>珈琲とドーナツを愛するWebアプリケーションエンジニア。React/ReduxとNode.jsが好き</p>
  <img src="/images/mii.jpg" width="100px" alt="profile photo" />
</section>
<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2017/01/24/react-advance/">React初めました (応用編)</a>
      </li>
    
      <li class="post">
        <a href="/blog/2017/01/23/react-basic/">React初めました (基礎編)</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/01/30/provisioning-03/">プロビジョニング事始め (3) Chef Zero編</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/12/18/provisioning-02/">プロビジョニング事始め (2) Vagrant編</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/12/01/provisioning-01/">プロビジョニング事始め (1) Ruby環境構築編</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  
  <a href="https://github.com/satoshiyamamoto">@satoshiyamamoto</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'satoshiyamamoto',
            count: 0,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>





  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2017 - 山本 聡 -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
